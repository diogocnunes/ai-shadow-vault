#!/bin/bash

VAULT_ROOT="$HOME/.gemini-vault"
PROJECT_NAME=$(basename "$PWD")
PROJECT_VAULT="$VAULT_ROOT/$PROJECT_NAME"

echo "üõ°Ô∏è  Initializing AI Shadow Vault for: $PROJECT_NAME"

# 1. Create Vault structure
mkdir -p "$PROJECT_VAULT"

# 2. Copy templates if they don't exist
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cp -n "$SCRIPT_DIR/../templates/AGENTS.md" "$PROJECT_VAULT/AGENTS.md"
cp -n "$SCRIPT_DIR/../templates/copilot-instructions.md" "$PROJECT_VAULT/copilot-instructions.md"
cp -n "$SCRIPT_DIR/../templates/.cursorrules" "$PROJECT_VAULT/.cursorrules"
cp -n "$SCRIPT_DIR/../templates/.windsurfrules" "$PROJECT_VAULT/.windsurfrules"
cp -n "$SCRIPT_DIR/../templates/cody-context.json" "$PROJECT_VAULT/cody-context.json"
cp -n "$SCRIPT_DIR/../templates/cody-ignore" "$PROJECT_VAULT/cody-ignore"

# 2.1 Dynamic Configuration for rules, Gemini and Claude
if [ -f "$SCRIPT_DIR/../scripts/vault-ai-configurator.sh" ]; then
    bash "$SCRIPT_DIR/../scripts/vault-ai-configurator.sh"
    # Move the generated files to the Vault
    [ -f "GEMINI.md" ] && mv "GEMINI.md" "$PROJECT_VAULT/GEMINI.md"
    [ -f "CLAUDE.md" ] && mv "CLAUDE.md" "$PROJECT_VAULT/CLAUDE.md"
    
    # Create symlinks immediately
    ln -sf "$PROJECT_VAULT/GEMINI.md" "GEMINI.md"
    ln -sf "$PROJECT_VAULT/CLAUDE.md" "CLAUDE.md"
    ln -sf "$PROJECT_VAULT/AGENTS.md" "AGENTS.md"
else
    cp -n "$SCRIPT_DIR/../templates/GEMINI.md" "$PROJECT_VAULT/GEMINI.md"
    cp -n "$SCRIPT_DIR/../templates/CLAUDE.md" "$PROJECT_VAULT/CLAUDE.md"
    ln -sf "$PROJECT_VAULT/GEMINI.md" "GEMINI.md"
    ln -sf "$PROJECT_VAULT/CLAUDE.md" "CLAUDE.md"
    ln -sf "$PROJECT_VAULT/AGENTS.md" "AGENTS.md"
fi

echo "‚úÖ Vault directory created at: $PROJECT_VAULT"

# 3. Laravel Boost Detection & Installation
if [ -f "composer.json" ]; then
    # Check if Laravel is in the dependencies
    if grep -q '"laravel/framework"' composer.json; then
        echo ""
        echo "üîç Laravel project detected!"
        echo -n "Would you like to install Laravel Boost? (y/n): "
        read -r response

        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo "üì¶ Installing Laravel Boost..."

            # Install Laravel Boost via composer
            if composer require "laravel/boost:^2.0" --dev; then
                echo "‚úÖ Laravel Boost package installed."

                # Run the Boost installer
                echo "üöÄ Running Laravel Boost installer..."
                if php artisan boost:install; then
                    echo "‚úÖ Laravel Boost installed successfully!"
                else
                    echo "‚ö†Ô∏è  Laravel Boost installer failed. Please check the errors above."
                fi
            else
                echo "‚ö†Ô∏è  Failed to install Laravel Boost package. Please check the errors above."
            fi
        else
            echo "‚è≠Ô∏è  Skipping Laravel Boost installation."
        fi
    fi
fi

# 4. Global Git Safety Net
echo "üîí Configuring Global Git Safety Net..."
GLOBAL_IGNORE="$HOME/.gitignore_global"
touch "$GLOBAL_IGNORE"

# Added GEMINI.md to the ignore list (+ Laravel Boost and Universal AI files)
FILES_TO_IGNORE=("GEMINI.md" ".opencode-context.md" "AGENTS.md" ".opencode.json" ".mcp.json" "CLAUDE.md" "boost.json" ".ai" ".ai/" "copilot-instructions.md" ".cursorrules" ".windsurfrules" "cody-context.json" "cody-ignore" ".github/" ".cody/" ".claude/" ".codex/" ".cursor/" ".gemini/" ".junie/" ".opencode/")

for file in "${FILES_TO_IGNORE[@]}"; do
    if ! grep -q "$file" "$GLOBAL_IGNORE"; then
        echo "**/$file" >> "$GLOBAL_IGNORE"
    fi
done

git config --global core.excludesfile "$GLOBAL_IGNORE"

# 4.1 Local Git Safety Net (Silent Ignore)
if [ -d ".git" ]; then
    echo "üôà Updating .git/info/exclude..."
    GIT_EXCLUDE=".git/info/exclude"
    touch "$GIT_EXCLUDE"
    for file in "${FILES_TO_IGNORE[@]}"; do
        if ! grep -q "$file" "$GIT_EXCLUDE"; then
            echo "$file" >> "$GIT_EXCLUDE"
        fi
    done
elif [ -f ".gitignore" ]; then
    echo "üìù Updating local .gitignore..."
    for file in "${FILES_TO_IGNORE[@]}"; do
        if ! grep -q "$file" ".gitignore"; then
            echo "$file" >> ".gitignore"
        fi
    done
fi

echo "‚úÖ Git Safety Net updated (Global + Local Exclude)."



# 5. AI Cache System Activation

echo ""

echo "üõ°Ô∏è  AI Cache System Expansion"

echo -n "Would you like to activate the AI Cache System for this project? (y/n): "

read -r ai_response



if [[ "$ai_response" =~ ^[Yy]$ ]]; then

    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    if [ -f "$SCRIPT_DIR/vault-ai-init" ]; then

        "$SCRIPT_DIR/vault-ai-init"

    else

        "$SCRIPT_DIR/../scripts/vault-ai-init.sh"

    fi

else

    echo "‚è≠Ô∏è  Skipping AI Cache System activation."

fi
